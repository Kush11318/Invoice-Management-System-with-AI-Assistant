{% extends "base.html" %}

{% block title %}Edit Invoice - Invoice Management System{% endblock %}

{% block back_button %}
<a href="{{ url_for('seller_invoices') }}" class="btn btn-outline btn-sm back-btn">
    <i class="fas fa-arrow-left"></i>
    Back to Invoices
</a>
{% endblock %}

{% block content %}

<div class="dashboard">
    <div class="section-header">
        <h2 class="section-title">Edit Invoice {{ invoice.id }}</h2>
    </div>

    {% if invoice.status == 'cancelled' %}
    <div class="card" style="background-color: #fee; border: 2px solid #fcc; margin-bottom: 16px;">
        <p style="color: #c00; font-weight: 600;">
            <i class="fas fa-exclamation-triangle"></i>
            This invoice is cancelled and cannot be edited.
        </p>
    </div>
    {% endif %}

    <form method="POST" class="invoice-form" {% if invoice.status=='cancelled'
        %}onsubmit="event.preventDefault(); alert('Cannot edit a cancelled invoice'); return false;" {% endif %}>
        <div class="card">
            <h3 class="form-section-title">Invoice Information</h3>
            <div class="form-group">
                <label class="form-label">Invoice Number</label>
                <input type="text" class="form-input" value="{{ invoice.id }}" readonly>
            </div>
            <div class="form-group">
                <label class="form-label">Customer</label>
                <input type="text" class="form-input" value="{{ invoice.customer_name }} ({{ invoice.customer_email }})"
                    readonly>
            </div>
            <div class="form-group">
                <label class="form-label">Date</label>
                <input type="text" class="form-input" value="{{ invoice.date }}" readonly>
            </div>
            <div class="form-group">
                <label class="form-label">Due Date</label>
                <input type="date" name="due_date" class="form-input"
                    value="{% if invoice.due_date_str %}{{ invoice.due_date_str }}{% endif %}" style="max-width: 200px">
            </div>
            <div class="form-group">
                <label class="form-label">Status</label>
                <select name="status" class="form-input">
                    <option value="pending" {% if invoice.status=='pending' %}selected{% endif %}>Pending</option>
                    <option value="paid" {% if invoice.status=='paid' %}selected{% endif %}>Paid</option>
                    <option value="overdue" {% if invoice.status=='overdue' %}selected{% endif %}>Overdue</option>
                    <option value="cancelled" {% if invoice.status=='cancelled' %}selected{% endif %}>Cancelled</option>
                </select>
            </div>
        </div>

        <div class="card">
            <div class="form-section-header">
                <h3 class="form-section-title">Invoice Items</h3>
                <button type="button" class="btn btn-primary" onclick="addNewItem()">
                    <i class="fas fa-plus"></i>
                    Add Item
                </button>
            </div>
            <div class="invoice-items" id="invoice-items-container">
                {% for item in invoice.items %}
                <div class="invoice-item" data-item-id="{{ item.item_id }}">
                    <div class="item-row">
                        <div class="form-group">
                            <label class="form-label">Product</label>
                            <select name="product_{{ item.item_id }}" class="form-input product-select"
                                onchange="updateItemTotal({{ item.item_id }})">
                                {% for product in products %}
                                <option value="{{ product.id }}" {% if product.id==item.p_id %}selected{% endif %}
                                    data-price="{{ product.price }}">
                                    {{ product.name }} - ₹{{ "%.2f"|format(product.price) }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Quantity</label>
                            <input type="number" name="quantity_{{ item.item_id }}" class="form-input quantity-input"
                                value="{{ item.quantity }}" min="1" onchange="updateItemTotal({{ item.item_id }})">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Price</label>
                            <input type="text" class="form-input price-display" value="₹{{ " %.2f"|format(item.price)
                                }}" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Discount (₹)</label>
                            <input type="number" name="discount_{{ item.item_id }}" class="form-input discount-input"
                                value="{{ " %.2f"|format(item.discount) }}" min="0" step="5"
                                onchange="updateItemTotal({{ item.item_id }})">
                        </div>
                        <div class="item-total">
                            <label class="form-label">Total</label>
                            <div class="total-display" id="item-total-{{ item.item_id }}">₹{{ "%.2f"|format((item.price
                                * item.quantity) - item.discount) }}</div>
                        </div>
                        <div class="item-actions">
                            <button type="button" class="btn btn-danger btn-sm"
                                onclick="deleteItem({{ item.item_id }})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="card">
            <h3 class="form-section-title">Invoice Summary</h3>
            <div class="invoice-summary">
                <div class="summary-row">
                    <span>Subtotal:</span>
                    <span>₹{{ "%.2f"|format(invoice.amount - invoice.tax) }}</span>
                </div>
                <div class="summary-row">
                    <span>Tax (₹):</span>
                    <input type="number" name="tax" class="form-input tax-input" min="0" step="1" value="{{ "
                        %.2f"|format(invoice.tax) }}">
                </div>
                <div class="summary-row total">
                    <span>Total:</span>
                    <span>₹{{ "%.2f"|format(invoice.amount) }}</span>
                </div>
            </div>
        </div>

        <div class="form-actions">
            <a href="{{ url_for('seller_invoices') }}" class="btn btn-outline">
                Cancel
            </a>
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i>
                Update Invoice
            </button>
        </div>
    </form>
</div>

<script>
    const products = {{ products | tojson }};
    let newItemCounter = 0;

    function updateItemTotal(itemId) {
        const itemDiv = document.querySelector(`.invoice-item[data-item-id="${itemId}"]`);
        if (!itemDiv) return;

        const productSelect = itemDiv.querySelector('select.product-select');
        const quantityInput = itemDiv.querySelector('input.quantity-input');
        const discountInput = itemDiv.querySelector('input.discount-input');
        const priceDisplay = itemDiv.querySelector('.price-display');
        const totalDisplay = itemDiv.querySelector('.total-display');

        if (productSelect && quantityInput && discountInput) {
            const selectedOption = productSelect.options[productSelect.selectedIndex];
            const price = parseFloat(selectedOption.dataset.price) || 0;
            const quantity = parseInt(quantityInput.value) || 0;
            const discount = parseFloat(discountInput.value) || 0;

            priceDisplay.value = `₹${price.toFixed(2)}`;
            const total = (price * quantity) - discount;
            totalDisplay.textContent = `₹${total.toFixed(2)}`;
        }

        updateTotals();
    }

    function updateTotals() {
        let subtotal = 0;
        const items = document.querySelectorAll('.invoice-item:not([style*="display: none"])');

        items.forEach(item => {
            const totalDisplay = item.querySelector('.total-display');
            if (totalDisplay) {
                const totalText = totalDisplay.textContent.replace('₹', '');
                subtotal += parseFloat(totalText) || 0;
            }
        });

        const tax = parseFloat(document.querySelector('input[name="tax"]').value) || 0;
        const total = subtotal + tax;

        const subtotalSpan = document.querySelector('.summary-row:nth-child(1) span:last-child');
        const totalSpan = document.querySelector('.summary-row.total span:last-child');

        if (subtotalSpan) subtotalSpan.textContent = `₹${subtotal.toFixed(2)}`;
        if (totalSpan) totalSpan.textContent = `₹${total.toFixed(2)}`;
    }

    function deleteItem(itemId) {
        const itemDiv = document.querySelector(`.invoice-item[data-item-id="${itemId}"]`);
        if (itemDiv && confirm('Are you sure you want to delete this item?')) {
            // Add hidden input to mark item for deletion
            const deleteInput = document.createElement('input');
            deleteInput.type = 'hidden';
            deleteInput.name = `delete_${itemId}`;
            deleteInput.value = '1';
            document.querySelector('form').appendChild(deleteInput);

            itemDiv.style.display = 'none';
            updateTotals();
        }
    }

    function addNewItem() {
        newItemCounter++;
        const container = document.getElementById('invoice-items-container');
        const newItemDiv = document.createElement('div');
        newItemDiv.className = 'invoice-item';
        newItemDiv.innerHTML = `
        <div class="item-row">
            <div class="form-group">
                <label class="form-label">Product</label>
                <select name="new_product_${newItemCounter}_id" class="form-input product-select" onchange="updateNewItemTotal(${newItemCounter})">
                    <option value="">Select product...</option>
                    ${products.map(p => `<option value="${p.id}" data-price="${p.price}">${p.name} - ₹${p.price.toFixed(2)}</option>`).join('')}
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Quantity</label>
                <input type="number" name="new_quantity_${newItemCounter}" class="form-input quantity-input" value="1" min="1" onchange="updateNewItemTotal(${newItemCounter})">
            </div>
            <div class="form-group">
                <label class="form-label">Price</label>
                <input type="text" class="form-input price-display" value="₹0.00" readonly>
            </div>
            <div class="form-group">
                <label class="form-label">Discount (₹)</label>
                <input type="number" name="new_discount_${newItemCounter}" class="form-input discount-input" value="0" min="0" step="5" onchange="updateNewItemTotal(${newItemCounter})">
            </div>
            <div class="item-total">
                <label class="form-label">Total</label>
                <div class="total-display" id="new-item-total-${newItemCounter}">₹0.00</div>
            </div>
            <div class="item-actions">
                <button type="button" class="btn btn-danger btn-sm" onclick="removeNewItem(${newItemCounter})">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `;
        container.appendChild(newItemDiv);
    }

    function updateNewItemTotal(counter) {
        const itemDiv = document.querySelector(`select[name="new_product_${counter}_id"]`).closest('.invoice-item');
        if (!itemDiv) return;

        const productSelect = itemDiv.querySelector('select.product-select');
        const quantityInput = itemDiv.querySelector('input.quantity-input');
        const discountInput = itemDiv.querySelector('input.discount-input');
        const priceDisplay = itemDiv.querySelector('.price-display');
        const totalDisplay = itemDiv.querySelector('.total-display');

        if (productSelect && quantityInput && discountInput) {
            const selectedOption = productSelect.options[productSelect.selectedIndex];
            const price = parseFloat(selectedOption.dataset.price) || 0;
            const quantity = parseInt(quantityInput.value) || 0;
            const discount = parseFloat(discountInput.value) || 0;

            priceDisplay.value = `₹${price.toFixed(2)}`;
            const total = (price * quantity) - discount;
            totalDisplay.textContent = `₹${total.toFixed(2)}`;
        }

        updateTotals();
    }

    function removeNewItem(counter) {
        const itemDiv = document.querySelector(`select[name="new_product_${counter}_id"]`)?.closest('.invoice-item');
        if (itemDiv) {
            itemDiv.remove();
            updateTotals();
        }
    }

    // Initialize totals for existing items
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.invoice-item[data-item-id]').forEach(item => {
            const itemId = item.dataset.itemId;
            if (itemId) {
                updateItemTotal(itemId);
            }
        });
        updateTotals();
    });

    // Add event listeners
    document.querySelector('input[name="tax"]')?.addEventListener('input', updateTotals);
    document.querySelectorAll('input.discount-input').forEach(input => {
        input.addEventListener('input', function () {
            const itemId = this.closest('.invoice-item')?.dataset.itemId;
            if (itemId) {
                updateItemTotal(itemId);
            }
        });
    });
</script>
{% endblock %}